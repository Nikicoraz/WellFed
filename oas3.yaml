openapi: 3.0.0
info:
    version: '1.0'
    title: "WellFed OpenAPI 3.0"
    description: API for WellFed.
    license:
        name: MIT
servers:
    - url: http://127.0.0.1:8000/api/v1
      description: Local development server
    - url: https://changeme.server/api/v1
      description: Production server

tags:
  - name: User Actions
    description: Actions made by the user
  - name: Shop
    description: Operations regarding the shop
  - name: Notification
    description: Operations regarding the notifications
  - name: QRCode
    description: Operations made with QRCodes
  - name: Transaction
    description: Operations made with transactions

# TODO: login e registrazione SSO dopo aver capito come funziona...
paths:
    /login:
        summary: Login with credentials
        post:
            summary: Send the login request
            tags:
              - User Actions
            requestBody:
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                email:
                                    type: string
                                    description: Email of the user trying to login
                                    example: "mariorossi@gmail.com"
                                password:
                                    type: string
                                    description: The cleartext password of the user
                                    example: password123
            responses:
                "401":
                    description: Invalid credentials
                "200":
                    description: User logged in successfully
                    content:
                        application/json:
                            schema:
                                type: object
                                properties:
                                    token:
                                        type: string
                                        description: The JWT token
                    headers:
                        'Location':
                            description: Link to the default page for the user
                            schema:
                                type: string
    /register/client:
        summary: Register a client type user
        post:
            tags:
              - User Actions
            summary: Send a registration request for a client type user
            requestBody:
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                username:
                                    type: string
                                    description: Username of the user
                                    example: "MRossi"
                                email:
                                    type: string
                                    description: Email of the user
                                    example: "mariorossi@gmail.com"
                                password:
                                    type: string
                                    description: The cleartext password of the user
                                    example: password123
            responses:
                "409":
                    description: The email is already in use
                "400":
                    description: The input data is not valid
                "201":
                    # Non serve location header siccome sappiamo che si è registrato un cliente,
                    # e quindi sappiamo anche la sua landing page
                    description: Account created successfully
    
    /register/merchant:
        # Merchant guild rise up
        summary: Register a merchant type user
        post:
            tags:
              - User Actions
            summary: Send a registration request for the merchant type user
            requestBody:
                content:
                    application/json:
                        schema:
                            $ref: "#/components/schemas/Merchant"
                    
            responses:
                "409":
                    description: Name or email already in use
                "403":
                    description: Validation of Partita IVA failed
                "400":
                    description: Input data is invalid
                "202":
                    description: Request accepted for manual verification
    
    /shops:
        summary: The registered shops
        get:
            tags:
              - Shop
            summary: Returns a list of registered shops
            responses:
                "200":
                    description: A JSON array of shops
                    content:
                        application/json:
                            schema:
                                type: array
                                items:
                                    $ref: "#/components/schemas/Shop"

    /shops/{shopID}:
        summary: Opration on a single shop
        get:
            tags:
                - Shop
            summary: Get the shop details
            responses:
                "404":
                    description: Shop not found
                "200":
                    description: The details of the shop
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Shop"
    
    /notifications:
        get:
            summary: Get the list of notifications of the authenticated user
            tags:
              - Notification
            security:
                - BearerAuth: []
            responses:
                "401":
                    description: The user is not logged in
                "200":
                    description: The list of notifications for the user
                    content:
                        application/json:
                            schema:
                                type: array
                                items:
                                    $ref: "#/components/schemas/Notification"

    /notifications/{notificationID}:
        patch:
            summary: Set a notification status to read
            tags:
              - Notification
            security:
                - BearerAuth: []
            parameters:
              - in: path
                name: notificationID
                required: true
                schema:
                    type: integer
                    minimum: 0
                description: The notification ID to mark as read
            responses:
                "401":
                    description: The user is not logged in or cannot access the notification
                "200":
                    description: The notification has been marked as read

        delete:
            summary: Delete a notification
            tags:
              - Notification
            security:
                - BearerAuth: []
            parameters:
              - in: path
                name: notificationID
                required: true
                schema:
                    type: integer
                    minimum: 0
                description: The notification ID to delete
            responses:
                "401":
                    description: The user is not logged in or cannot access the notification
                "200":
                    description: The notification has been deleted
    /search:
        get:
            summary: Get search results from a query
            tags:
              - User Actions
            parameters:
              - in: query
                name: query
                required: false
                schema:
                    type: string
                    description: The text query to search for a shop or product
              - in: query
                name: filters
                required: false
                schema:
                    type: array
                    description: The filters to apply to the search (eg. distance)
                    # TODO: Scrivere i filtri della ricerca che abbiamo implementato
                    items:
                        type: string
                        enum:
                        - A
                        - B
                        - C

            responses:
                "200":
                    description: The search result list
                    content:
                      application/json:
                        schema:
                            $ref: "#/components/schemas/SearchResults"

    /shops/{shopID}/products:
        parameters:
          - in: path
            name: shopID
            required: true
            schema:
                type: string 
                description: The id of the shop whose products you want
        get:
            summary: Returns the list of products sold at a certain shop
            tags:
              - Shop
            responses:
                "200":
                    description: Returns the list of products
                    content:
                        application/json:
                            schema:
                                type: array
                                items:
                                    $ref: "#/components/schemas/Product"
        # TODO: Le immagini inviate dall'utente non possono essere stringhe
        # TODO: Cambiare gli id da Integer a String
        post:
            summary: Adds a product to the shop
            tags:
              - Shop
            security:
              - BearerAuth: []
            requestBody:
                content:
                    multipart/form-data:
                        schema:
                            type: object
                            properties:
                                name:
                                    type: string
                                    description: The name of the product
                                    example: Ciliegie
                                description:
                                    type: string
                                    description: The description of the product
                                    example: Delle ciliegie provenienti dal mio orto
                                origin:
                                    type: string
                                    description: The place of origin of the product
                                    example: Il mio orto
                                points:
                                    type: integer
                                    minimum: 0
                                    description: The number of points assigned to the client when this product is bought
                                    example: 5
                                
                                # File dell'immagine (inviato come campo file)
                                image:
                                    type: string
                                    format: binary
                                    description: The product image file
                            required:
                                - name
                                - description
                                - origin
                                - image
                    image/jpeg:
                        schema:
                            type: string
                            format: binary
            responses:
                "201":
                    description: The product was added to the shop
                "400":
                    description: The product had some invalid data
        

    /shops/{shopID}/products/{productID}:
        description: Operations on a single product
        parameters:
          - in: path
            name: shopID
            required: true
            schema:
                type: integer
                minimum: 0
                description: The ID of the shop
          - in: path
            name: productID
            required: true
            schema:
                type: integer
                minimum: 0
                description: The ID of the product
        get:
            summary: Returns the details of single product
            tags:
              - Shop
            responses:
                "404":
                    description: "The product was not found"
                "200":
                    description: "The product details"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Product"
        
        patch:
            summary: Modifies some attributes of a product
            tags:
              - Shop
            security:
              - BearerAuth: []
            requestBody:
                content:
                  application/json:
                    schema:
                        # Riscrivo lo schema del prodotto siccome non è obbligatorio
                        # fornire tutti i campi e non è possibile cambiare ID
                        type: object
                        properties:
                            name: 
                                type: string
                                description: Product name
                                example: Ciliegie
                            description:
                                type: string
                                description: Product description
                                example: Delle ciliegie provenienti dal mio orto
                            origin:
                                type: string
                                description: Product location of origin
                                example: Il mio orto
                            image:
                                type: string
                                description: URL of where to find the product image
                                example: /public/img/22006f1b2ad92b54295.png
                            points:
                                type: integer
                                minimum: 0
                                description: The number of points assigned on a purchase
                                example: 5
            responses:
                "200":
                    description: The edit was successful
                "400":
                    description: The new product attributes contain errors
        
        delete:
            summary: Deletes a product
            tags:
              - Shop
            security:
              - BearerAuth: []
            responses:
                "200":
                    description: The product was deleted

    /shops/{shopID}/prizes:
        parameters:
          - in: path
            name: shopID
            required: true
            schema:
                type: integer
                minimum: 0
                description: The id of the shop whose prizes you want
        get:
            summary: Returns the list of prizes sold at a certain shop
            tags:
              - Shop
            responses:
                "200":
                    description: Returns the list of prizes
                    content:
                        application/json:
                            schema:
                                type: array
                                items:
                                    $ref: "#/components/schemas/Prize"
        post:
            summary: Adds a prizes to the shop
            tags:
              - Shop
            security:
              - BearerAuth: []
            requestBody:
                content:
                    application/json:
                        schema:
                            $ref: "#/components/schemas/Prize"
            responses:
                "201":
                    description: The prize was added to the shop
                "400":
                    description: The prize had some invalid data
        

    /shops/{shopID}/prizes/{prizeID}:
        description: Operations on a single prize
        parameters:
          - in: path
            name: shopID
            required: true
            schema:
                type: integer
                minimum: 0
                description: The ID of the shop
          - in: path
            name: prizeID
            required: true
            schema:
                type: integer
                minimum: 0
                description: The ID of the prize
        get:
            summary: Returns the details of single prize
            tags:
              - Shop
            responses:
                "404":
                    description: "The prize was not found"
                "200":
                    description: "The prize details"
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Prize"
        
        patch:
            summary: Modifies some attributes of a prize
            tags:
              - Shop
            security:
              - BearerAuth: []
            requestBody:
                content:
                  application/json:
                    schema:
                        # Riscrivo lo schema del premio siccome non è obbligatorio
                        # fornire tutti i campi e non è possibile cambiare ID
                        type: object
                        properties:
                            name: 
                                type: string
                                description: Prize name
                                example: Cestino natale 1
                            description:
                                type: string
                                description: Prize description
                                example: >
                                    Un piccolo cestino di natale contenente polenta,
                                    un salame, qualche formaggio e della pasta
                            image:
                                type: string
                                description: URL of where to find the prize image
                                example: /public/img/32106f1b2ad92b54295.png
                            points:
                                type: integer
                                minimum: 1
                                description: The number of points required to redeem the prize
                                example: 40
            responses:
                "200":
                    description: The edit was successful
                "400":
                    description: The new prize attributes contain errors
        
        delete:
            summary: Deletes a prize
            tags:
              - Shop
            security:
              - BearerAuth: []
            responses:
                "200":
                    description: The prize was deleted

    /QRCodes/assignPoints:
        get:
            summary: Generates a QR with which a merchant can assign points to a user
            tags:
              - QRCode
            security:
                - BearerAuth: []
            requestBody:
                # Prodotti acquistati
                content:
                    application/json:
                        schema:
                            type: array
                            items:
                                type: object
                                properties:
                                    productID:
                                        type: integer
                                        minimum: 0
                                        description: The ID of the purchased product
                                    quantity:
                                        type: integer
                                        minimum: 1
                                        description: The quantity of the single product that was purchased
                                required:
                                    - productID
                                    - quantity
            responses:
                "401":
                    description: The user is not logged in, so it cannot generate
                "200":
                    description: The QR code is generated
                    content:
                        image/jpeg:
                            schema:
                                type: string
                                format: binary

    /QRCodes/redeemPrize:
        get:
            summary: Generates a QR with which a user can redeem a prize
            tags:
              - QRCode
            security:
                - BearerAuth: []
            requestBody:
                # Prodotti acquistati
                content:
                    application/json:
                        schema:
                            type: object
                            properties:
                                prizeID:
                                    type: integer
                                    minimum: 0
                                    description: The id of the prize to redeem
                            required:
                                - prizeID

            responses:
                "401":
                    description: The user is not logged in, so it cannot generate
                "200":
                    description: The QR code is generated
                    content:
                        image/jpeg:
                            schema:
                                type: string
                                format: binary
    /QRCodes/scanned:
        post:
            summary: After scanning a QR code, send the data to processing
            tags:
              - QRCode
            security:
              - BearerAuth: []
            requestBody:
                content:
                    image/jpeg:
                        schema:
                            type: string
                            format: binary
            responses:
                "200":
                    description: The QR code was processed successfully
                "400":
                    description: The QR code is invalid
    
    /transactions:
        get:
            summary: Get all the transactions for a user
            security:
              - BearerAuth: []
            tags:
              - Transaction
            responses:
                "200":
                    description: An array of transactions
                    content:
                        application/json:
                            schema:
                                $ref: "#/components/schemas/Transaction"
components:
    securitySchemes:
      BearerAuth:
        type: http
        scheme: bearer
        bearerFormat: JWT

    schemas:
        Shop:
            type: object
            properties:
                id:
                    type: integer
                    description: ID of the shop
                name:
                    type: string
                    description: Name of the shop
                    example: "Gianni & Co"
                address:
                    type: string
                    description: The address of the shop
                    example: "Via Sommarive, 5, 38123 Trento TN"
                image:
                    type: string
                    description: Public path of the shop banner image
                    example: "/public/img/a22a571b4df0db2b46.png"
            required:
                - id
                - name
        Merchant:
            type: object
            properties:
                name:
                    type: string
                    description: The name of the merchant's shop
                    example: "Luca Bianchi"
                partitaIVA:
                    type: string
                    description: The Partita IVA of the merchant
                    example: "12345678901"
                address:
                    type: string
                    description: The shop address
                    example: "Via Sommarive, 5, 38123 Trento TN"
                email:
                    type: string
                    description: The email address of the merchant
                    example: "l.bianchi@gmail.com"
                password:
                    type: string
                    description: The cleartext password to access the merchant's account
                    example: "bestshopever"
            required:
                - name
                - partitaIVA
                - address
                - email
                - password
        Notification:
            type: object
            properties:
                id:
                    type: integer
                    description: The notification id
                shopLink:
                    type: string
                    description: The link to the shop issuer
                    example: /shop/1
                viewed:
                    type: boolean
                    description: If the user has already opened and read the notification
                notificationMessage:
                    type: string
                    description: An optional message to display in the notification (eg. when a new offer is out)
                    example: C'è un nuovo premio disponibile presso Gianni & Co.
            required:
                - id
                - shopLink
                - viewed
                - notificationMessage
        Product:
            type: object
            properties:
                id:
                    type: integer
                    description: The id of the product
                name:
                    type: string
                    description: The name of the product
                    example: Ciliegie
                description:
                    type: string
                    description: The description of the product
                    example: Delle ciliegie provenienti dal mio orto
                origin:
                    type: string
                    description: The place of origin of the product
                    example: Il mio orto
                image:
                    type: string
                    description: The URL path of the image of the product
                    example: /public/img/22006f1b2ad92b54295.png
                points:
                    type: integer
                    minimum: 0
                    description: The number of points assigned to the client when this product is bought
                    example: 5
            required:
                - name
                - description
                - origin
                - image

        SearchResults:
            type: object
            properties:
                shops:
                    type: array
                    items:
                        $ref: "#/components/schemas/Shop"
                products:
                    type: array
                    items:
                        $ref: "#/components/schemas/Product"

        Prize:
            type: object
            properties:
                id:
                    type: integer
                    minimum: 0
                    description: The id of the prize
                name: 
                    type: string
                    description: The name of the prize
                    example: Cestino natale 1
                description:
                    type: string
                    description: The description of the prize
                    example: >
                            Un piccolo cestino di natale contenente polenta, un salame, qualche formaggio
                            e della pasta
                image:
                    type: string
                    description: The URL of the image of the prize
                    example: /public/img/32106f1b2ad92b54295.png
                points:
                    type: integer
                    minimum: 1
                    description: The number of points necessary to redeem the prize
                    example: 40
            required:
              - name
              - description
              - image
              - points
        Transaction:
            type: array
            items:
                type: object
                properties:
                    issuerID:
                        type: object
                        description: The the issuer properties
                        properties:
                            id: 
                                type: integer
                                description: the ID of the issuer
                            type:
                                type: string
                                description: The user type of the issuer
                                enum: 
                                    - client
                                    - merchant
                        required:
                            - id
                            - type
                    receiverID:
                        type: object
                        description: The the receiver properties
                        properties:
                            id: 
                                type: integer
                                description: the ID of the receiver
                            type:
                                type: string
                                description: The user type of the receiver
                                enum: 
                                    - client
                                    - merchant
                                example: merchant
                        required:
                            - id
                            - type
                    points:
                        type: integer
                        description: The number of points involved in the transaction
                        minimum: 1
                    transactionType:
                        type: string
                        description: The transaction type
                        enum:
                            - PointAssignment
                            - PrizeRedeem
                    transactionStatus:
                        type: string
                        description: The status of the transaction
                        enum:
                            - Success
                            - Insuccess
                    items:
                        type: object
                        properties:
                            products:
                                type: array
                                items:
                                    type: integer
                                    description: ID of the products
                            prizes:
                                type: array
                                items:
                                    type: integer
                                    description: ID of the prizes

                required:
                    - issuerID
                    - receiverID
                    - points
                    - transactionType
                    - transactionStatus
                    - items

